<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchases</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Medical Store</a>
    </div>
  </nav>

  <div class="container mt-4">
    <h2>Record a New Purchase</h2>
    <form class="row g-3 mb-5" action="/purchases/add" method="POST" id="purchase-form">
      <div class="col-md-6">
        <label class="form-label">Customer Name</label>
        <input type="text" name="customer_name" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Operator Name</label>
        <input type="text" name="operator_name" class="form-control" required>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Add Items</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" id="barcode-input" class="form-control" placeholder="Scan or enter barcode">
                  <button type="button" class="btn btn-outline-secondary" id="start-scan">Start Scanner</button>
                </div>
                <div id="reader" class="mt-2" style="display: none;"></div>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-primary" id="add-manual-item">Add Item Manually</button>
              </div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Medicine</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="purchase-items">
                  <!-- Items will be added here dynamically -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                    <td colspan="2"><strong id="total-amount">0.00</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Purchase Date</label>
        <input type="date" name="purchase_date" class="form-control" required>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-success">Complete Purchase</button>
      </div>
    </form>

    <h2>Purchase History</h2>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Customer</th>
          <th>Medicine</th>
          <th>Qty</th>
          <th>Operator</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        {% for purchase in purchases %}
        <tr>
          <td>{{ purchase.customer }}</td>
          <td>{{ purchase.medicine }}</td>
          <td>{{ purchase.quantity }}</td>
          <td>{{ purchase.operator }}</td>
          <td>{{ purchase.date }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Manual Entry Modal -->
  <div class="modal fade" id="manualEntryModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Medicine Manually</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="manual-entry-form">
            <div class="mb-3">
              <label class="form-label">Medicine Name</label>
              <input type="text" class="form-control" id="manual-medicine-name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Price</label>
              <input type="number" class="form-control" id="manual-price" step="0.01" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Quantity</label>
              <input type="number" class="form-control" id="manual-quantity" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="add-manual-item-confirm">Add Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let html5QrcodeScanner = null;
    let itemCount = 0;
    const manualEntryModal = new bootstrap.Modal(document.getElementById('manualEntryModal'));

    // Start scanner
    document.getElementById('start-scan').addEventListener('click', function() {
      const reader = document.getElementById('reader');
      if (reader.style.display === 'none') {
        reader.style.display = 'block';
        html5QrcodeScanner = new Html5QrcodeScanner(
          "reader", { fps: 10, qrbox: 250 });
        
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      } else {
        reader.style.display = 'none';
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear();
        }
      }
    });

    // Manual entry button
    document.getElementById('add-manual-item').addEventListener('click', function() {
      manualEntryModal.show();
    });

    // Add manual item
    document.getElementById('add-manual-item-confirm').addEventListener('click', function() {
      const name = document.getElementById('manual-medicine-name').value;
      const price = parseFloat(document.getElementById('manual-price').value);
      const quantity = parseInt(document.getElementById('manual-quantity').value);

      if (name && price && quantity) {
        addItemToTable({
          name: name,
          price: price,
          quantity: quantity
        });
        manualEntryModal.hide();
        document.getElementById('manual-entry-form').reset();
      }
    });

    function onScanSuccess(decodedText, decodedResult) {
      // Stop the scanner
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
        document.getElementById('reader').style.display = 'none';
      }

      // Set the barcode value
      document.getElementById('barcode-input').value = decodedText;

      // Fetch medicine details
      fetchMedicineDetails(decodedText);
    }

    function onScanFailure(error) {
      console.warn(`QR code scanning failed: ${error}`);
    }

    async function fetchMedicineDetails(barcode) {
      try {
        const response = await fetch(`/api/medicines/barcode/${barcode}`);
        const data = await response.json();
        
        // Add the item to the table
        addItemToTable({
          name: data.name,
          price: data.price,
          quantity: 1 // Default quantity
        });

        // Clear the barcode input
        document.getElementById('barcode-input').value = '';
      } catch (error) {
        console.error('Error fetching medicine details:', error);
        alert('Medicine not found. Please try manual entry.');
      }
    }

    function addItemToTable(item) {
      const tbody = document.getElementById('purchase-items');
      const tr = document.createElement('tr');
      const total = item.price * item.quantity;

      tr.innerHTML = `
        <td>
          <input type="hidden" name="items[${itemCount}][name]" value="${item.name}">
          ${item.name}
        </td>
        <td>
          <input type="hidden" name="items[${itemCount}][price]" value="${item.price}">
          ${item.price.toFixed(2)}
        </td>
        <td>
          <input type="number" name="items[${itemCount}][quantity]" 
                 class="form-control form-control-sm quantity-input" 
                 value="${item.quantity}" min="1" 
                 onchange="updateItemTotal(this)">
        </td>
        <td class="item-total">${total.toFixed(2)}</td>
        <td>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">Remove</button>
        </td>
      `;

      tbody.appendChild(tr);
      itemCount++;
      updateTotalAmount();
    }

    function updateItemTotal(input) {
      const tr = input.closest('tr');
      const price = parseFloat(tr.querySelector('input[name^="items"][name$="[price]"]').value);
      const quantity = parseInt(input.value);
      const total = price * quantity;
      tr.querySelector('.item-total').textContent = total.toFixed(2);
      updateTotalAmount();
    }

    function removeItem(button) {
      button.closest('tr').remove();
      updateTotalAmount();
    }

    function updateTotalAmount() {
      const totals = Array.from(document.getElementsByClassName('item-total'))
        .map(el => parseFloat(el.textContent));
      const total = totals.reduce((sum, val) => sum + val, 0);
      document.getElementById('total-amount').textContent = total.toFixed(2);
    }

    // Form submission
    document.getElementById('purchase-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Validate that there are items
      if (itemCount === 0) {
        alert('Please add at least one item to the purchase.');
        return;
      }

      // Submit the form
      this.submit();
    });
  </script>
</body>
</html>
